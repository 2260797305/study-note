# tws 验证

## 验证内容：

1. master 与 slave 的 LATCH_TWS_CLKN  值是否同步；
2. LATCH_TWS_CLKN  值是否按照设置的period 值更新；
3. sample cnt 值的获取；
4. 是否按照设置的起播时间（REG_TWS_START_CNT）起播；



## 验证方法

1. 两台FPGA 烧录，运行；
2. master 搜索 slave 设备，连接；建立a2dp， spp 连接；
3. slave 端下tws enable 的hci 命令；
4. 手机连接master，创建 a2dp 连接；
5. master 端下tws enable 的hci 命令；
6. master 与 slave 各自开启一个task， 每隔 5 秒打印出 70【24】（LATCH_AUD_SAMPLE_CNT）与 70【26】（LATCH_TWS_CLKN）的值；
7. 手机端开始播放音乐，master 收到a2dp 数据，转传给 slave；
8. slave 收到 a2dp 数据，设定起播时间为当前时间（57【8】） + 20000（6250 ms）;latch period 值为10；将两个值由spp 发送给master，同时将打印的task 的打印频率改为 50 ms；
9. master 收到spp 的数据，设置起播时间，period；同时将打印的task 的打印频率改为 50 ms；
10. 分析log， 得出结论；

## 验证log

log 如下：

 Cnt 为70【24】（LATCH_AUD_SAMPLE_CNT）， Clkn为 70【26】（LATCH_TWS_CLKN）

master 端：

```
(2019.06.27-16:20:31.663)Cnt 0, Clkn 0
(2019.06.27-16:20:36.662)Cnt 0, Clkn 0
(2019.06.27-16:20:41.668)Cnt 0, Clkn 0
(2019.06.27-16:20:46.665)Cnt 0, Clkn 0
(2019.06.27-16:21:01.709)Cnt 0, Clkn 0
(2019.06.27-16:21:02.450)start time is 444476, time_interval 10
(2019.06.27-16:21:02.450)uiStartSampleCnt 444476
(2019.06.27-16:21:02.450)uiLatchPeriod 10
(2019.06.27-16:21:06.686)Cnt 2, Clkn 438208
(2019.06.27-16:21:06.737)Cnt 2, Clkn 438368
(2019.06.27-16:21:06.773)Cnt 2, Clkn 438528
(2019.06.27-16:21:06.839)Cnt 2, Clkn 438688
(2019.06.27-16:21:06.890)Cnt 2, Clkn 438848
(2019.06.27-16:21:06.941)Cnt 2, Clkn 439008
(2019.06.27-16:21:06.981)Cnt 2, Clkn 439168
(2019.06.27-16:21:07.043)Cnt 2, Clkn 439328
(2019.06.27-16:21:07.094)Cnt 2, Clkn 439488
(2019.06.27-16:21:07.145)Cnt 2, Clkn 439648
(2019.06.27-16:21:07.181)Cnt 2, Clkn 439808
(2019.06.27-16:21:07.237)Cnt 2, Clkn 439968
(2019.06.27-16:21:07.278)Cnt 2, Clkn 440128
(2019.06.27-16:21:07.339)Cnt 2, Clkn 440288
(2019.06.27-16:21:07.384)Cnt 2, Clkn 440448
(2019.06.27-16:21:07.441)Cnt 2, Clkn 440608
(2019.06.27-16:21:07.482)Cnt 2, Clkn 440768
(2019.06.27-16:21:07.543)Cnt 2, Clkn 440928
(2019.06.27-16:21:07.587)Cnt 2, Clkn 441088
(2019.06.27-16:21:07.645)Cnt 2, Clkn 441248
(2019.06.27-16:21:07.686)Cnt 2, Clkn 441408
(2019.06.27-16:21:07.727)Cnt 2, Clkn 441568
(2019.06.27-16:21:07.787)Cnt 2, Clkn 441728
(2019.06.27-16:21:07.839)Cnt 2, Clkn 441888
(2019.06.27-16:21:07.890)Cnt 2, Clkn 442048
(2019.06.27-16:21:07.931)Cnt 2, Clkn 442208
(2019.06.27-16:21:07.991)Cnt 2, Clkn 442368
(2019.06.27-16:21:08.043)Cnt 2, Clkn 442528
(2019.06.27-16:21:08.094)Cnt 2, Clkn 442688
(2019.06.27-16:21:08.135)Cnt 2, Clkn 442848
(2019.06.27-16:21:08.195)Cnt 2, Clkn 443008
(2019.06.27-16:21:08.227)Cnt 2, Clkn 443168
(2019.06.27-16:21:08.298)Cnt 2, Clkn 443328
(2019.06.27-16:21:08.339)Cnt 2, Clkn 443488
(2019.06.27-16:21:08.389)Cnt 2, Clkn 443648
(2019.06.27-16:21:08.431)Cnt 2, Clkn 443808
(2019.06.27-16:21:08.502)Cnt 2, Clkn 443968
(2019.06.27-16:21:08.543)Cnt 2, Clkn 444128
(2019.06.27-16:21:08.603)Cnt 2, Clkn 444288
(2019.06.27-16:21:08.612)Cnt 2, Clkn 444448
(2019.06.27-16:21:08.696)Cnt 1809, Clkn 444608
(2019.06.27-16:21:08.747)Cnt 4016, Clkn 444768
(2019.06.27-16:21:08.787)Cnt 6361, Clkn 444938
(2019.06.27-16:21:08.814)Cnt 8431, Clkn 445088
(2019.06.27-16:21:08.889)Cnt 10638, Clkn 445248
```



slave 端：

```
20190627_16:20:46 Cnt 0, Clkn 0
20190627_16:20:51 Cnt 0, Clkn 0
20190627_16:20:56 Cnt 0, Clkn 0
20190627_16:21:01 Cnt 0, Clkn 0
20190627_16:21:02 tws config
20190627_16:21:02 uiStartSampleCnt 444476
20190627_16:21:02 uiLatchPeriod 10
20190627_16:21:02 send start config to master
20190627_16:21:06 Cnt 2, Clkn 437121
20190627_16:21:06 Cnt 2, Clkn 437281
20190627_16:21:06 Cnt 2, Clkn 437441
20190627_16:21:06 Cnt 2, Clkn 437601
20190627_16:21:06 Cnt 2, Clkn 437761
20190627_16:21:06 Cnt 2, Clkn 437921
20190627_16:21:06 Cnt 2, Clkn 438081
20190627_16:21:06 Cnt 2, Clkn 438241
20190627_16:21:06 Cnt 2, Clkn 438401
20190627_16:21:06 Cnt 2, Clkn 438561
20190627_16:21:06 Cnt 2, Clkn 438721
20190627_16:21:06 Cnt 2, Clkn 438881
20190627_16:21:06 Cnt 2, Clkn 439041
20190627_16:21:07 Cnt 2, Clkn 439201
20190627_16:21:07 Cnt 2, Clkn 439361
20190627_16:21:07 Cnt 2, Clkn 439521
20190627_16:21:07 Cnt 2, Clkn 439681
20190627_16:21:07 Cnt 2, Clkn 439841
20190627_16:21:07 Cnt 2, Clkn 440001
20190627_16:21:07 Cnt 2, Clkn 440161
20190627_16:21:07 Cnt 2, Clkn 440321
20190627_16:21:07 Cnt 2, Clkn 440481
20190627_16:21:07 Cnt 2, Clkn 440641
20190627_16:21:07 Cnt 2, Clkn 440801
20190627_16:21:07 Cnt 2, Clkn 440961
20190627_16:21:07 Cnt 2, Clkn 441121
20190627_16:21:07 Cnt 2, Clkn 441281
20190627_16:21:07 Cnt 2, Clkn 441441
20190627_16:21:07 Cnt 2, Clkn 441601
20190627_16:21:07 Cnt 2, Clkn 441761
20190627_16:21:07 Cnt 2, Clkn 441921
20190627_16:21:07 Cnt 2, Clkn 442081
20190627_16:21:07 Cnt 2, Clkn 442241
20190627_16:21:07 Cnt 2, Clkn 442401
20190627_16:21:08 Cnt 2, Clkn 442561
20190627_16:21:08 Cnt 2, Clkn 442721
20190627_16:21:08 Cnt 2, Clkn 442881
20190627_16:21:08 Cnt 2, Clkn 443041
20190627_16:21:08 Cnt 2, Clkn 443201
20190627_16:21:08 Cnt 2, Clkn 443361
20190627_16:21:08 Cnt 2, Clkn 443521
20190627_16:21:08 Cnt 2, Clkn 443681
20190627_16:21:08 Cnt 2, Clkn 443841
20190627_16:21:08 Cnt 2, Clkn 444001
20190627_16:21:08 Cnt 2, Clkn 444161
20190627_16:21:08 Cnt 2, Clkn 444321
20190627_16:21:08 Cnt 57, Clkn 444481
20190627_16:21:08 Cnt 2264, Clkn 444641
20190627_16:21:08 Cnt 4471, Clkn 444801
20190627_16:21:08 Cnt 6678, Clkn 444961
```

## 结果分析

由log 分析

在设置起播时间之前，Clkn 和 sample cnt 均为0；设置起播时间为 444476， period 为 10；

设置起播时间之后，Clkn 值同每个 10 个latch 更新一次，更新的值为57【8】；

在Clkn 值小于444476 之前，sample cnt 一直为 2；没有声音数据播出；

在Clkn 值到达444476 之后，sample cnt 值开始增加；

从master  设置起播开始（16:21:02.450），到有sample cnt 播出（16:21:08.696），其中时长为 6246 ms左右，除去spp 传输的延时，与设定时间相符；



## 资料

http://wiki2.sunplus.com/wiki/index.php/Q634/AUD/RegisterFile#Group_70

http://psweb.sunplus.com.tw/mantis_PD2/file_download.php?file_id=22466&type=bug

http://psweb.sunplus.com.tw/mantis_PD2/view.php?id=8643

http://wiki2.sunplus.com/wiki/index.php/IP-Spec:TWSABSCNT_I145

http://wiki2.sunplus.com/wiki/index.php/I145/ver_A:Programming_Guide

http://wiki2.sunplus.com/wiki/index.php/IP-Spec:TWS_Q634

